#!groovy

pipeline {
    agent any

    environment {
        MEGA_ZEP_BACKEND_APP_NAME = 'mega-zep-backend'
        OCP_PROJECT_NAME = "57-mega-dev"
        OCP_DOMAIN = 'cloud.itandtel.at'
        OCP_ROUTE_SUFFIX = "${env.OCP_PROJECT_NAME}.${env.OCP_DOMAIN}"
    }

    options {
        disableConcurrentBuilds()
    }

    stages {
        stage('Stash') {
            steps {
                stash name: "repo", includes: '**'
            }
        }

        stage("Build/Deploy") {
            parallel {
                stage('frontend') {
                    steps {
                        script {
                            podTemplate(cloud: 'openshift', name: 'nodejs-build-agent', label: 'nodejs-build-agent', serviceAccount: 'jenkins', containers: [
                                    containerTemplate(name: 'nodejs-container', image: 'docker-registry.default.svc:5000/57-mega-dev/nodejs-build-agent:latest',
                                            ttyEnabled: true, command: 'cat', alwaysPullImage: true, resourceRequestCpu: "1000m", resourceRequestMemory: "1Gi")
                            ]) {
                                node('nodejs-build-agent') {
                                    container('nodejs-container') {
                                        unstash name: "repo"

                                        dir('mega-zep-frontend/src/main/angular/frontend') {
                                            sh "npm install"
                                            sh 'mv -f src/environments/environment.prod.ts src/environments/environment.prod.tmp.ts'
                                        }

                                        buildFrontendForEnvironment('prod')
                                        buildFrontendForEnvironment('dev')
                                        buildFrontendForEnvironment('test')
                                    }
                                }
                            }
                        }
                    }
                }

                stage('backend') {
                    steps {
                        script {
                            podTemplate(cloud: 'openshift', name: 'quarkus-build-agent', label: 'quarkus-build-agent', serviceAccount: 'jenkins', containers: [
                                    containerTemplate(name: 'quarkus-container', image: 'docker-registry.default.svc:5000/57-mega-dev/quarkus-build-agent:latest', ttyEnabled: true, command: 'cat', alwaysPullImage: true,
                                            resourceRequestCpu: "1000m", resourceRequestMemory: "1Gi")
                            ],
                                    volumes: [
                                            persistentVolumeClaim(claimName: 'jenkins-mvn-repo-cache', mountPath: '/home/jenkins/.m2/repository')
                                    ]) {
                                node('quarkus-build-agent') {
                                    container('quarkus-container') {
                                        unstash name: "repo"

                                        def revision = buildRevisionForBranch()

                                        withCredentials([file(credentialsId: 'mega-secrets', variable: 'FILE')]) {
                                            sh "mkdir -p ./mega-zep-backend/config"
                                            sh "cp -f ${FILE} ./mega-zep-backend/config/application.properties"
                                            sh "mvn -B -s jenkins-settings.xml \
                                                   install \
                                                   -Drevision=${revision} \
                                                   -DskipTests \
                                                   -Dquarkus.package.uber.jar=true"
                                        }

                                        dir('mega-zep-backend/target/') {
                                            openshift.withCluster() {
                                                openshift.withProject("${OCP_PROJECT_NAME}") {
                                                    def artifact = "mega-zep-backend-${revision}-runner.jar"

                                                    sh "oc start-build mega-zep-backend --from-file=${artifact} --follow --wait"
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

def buildRevisionForBranch(String pomLocation = "./") {
    def branch = "${env.GIT_BRANCH}".trim().toLowerCase()
    def revision = "";
    if (branch.equals("develop")) {
        pom = readMavenPom file: pomLocation + 'pom.xml'
        return pom.properties['revision']
    } else if (branch.startsWith("feature/")) {
        return branch.replace("/", "-").toUpperCase()
    } else if (branch.startsWith("pr-")) {
        return branch.replace("/", "-").toUpperCase()
    } else if (branch.startsWith("release/") || branch.startsWith("hotfix/")) {
        pom = readMavenPom file: pomLocation + 'pom.xml'
        return pom.properties['revision']
    } else {
        error("Branch not detected. branch=${branch}")
    }
}

def buildFrontendForEnvironment(String environment) {
    withCredentials([file(credentialsId: 'google-secrets', variable: 'GOOGLE_SECRET_FILE')]) {
        def googleProps = readProperties file: "${GOOGLE_SECRET_FILE}"
        def routeSuffix;
        if ("prod".equals(environment)) {
            routeSuffix = "${env.MEGA_ZEP_BACKEND_APP_NAME}-57-services.${env.OCP_DOMAIN}"
        } else {
            routeSuffix = "${env.MEGA_ZEP_BACKEND_APP_NAME}-57-mega-zep-${environment}.${env.OCP_DOMAIN}"
        }
        def service = "https://${env.MEGA_ZEP_BACKEND_APP_NAME}-${env.OCP_ROUTE_SUFFIX}"

        dir('mega-zep-frontend/src/main/angular/frontend') {
            sh 'cp -f src/environments/environment.prod.tmp.ts src/environments/environment.prod.ts'
            sh "sed -i -e 's|REPLACE_BACKEND_ORIGIN|${service}|g' src/environments/environment.prod.tmp.ts > "
            sh "sed -i -e 's|REPLACE_OAUTH_CLIENT_ID|${googleProps['oauth.clientId']}|g' src/environments/environment.${environment}.ts"
            sh "npm install"
            sh "ng build --sourceMap=false --configuration=prod"
        }
    }

    dir('mega-zep-frontend/src/main/angular/frontend') {
        openshift.withCluster() {
            openshift.withProject("${OCP_PROJECT_NAME}") {
                sh "oc start-build mega-zep-frontend --commit=${env.GIT_COMMIT} \
                     --from-dir=dist/frontend \
                     --follow \
                     --wait"
                openshift.tag("mega-zep-frontend:latest", "mega-zep-frontend:latest-${environment}")
            }
        }
    }
}